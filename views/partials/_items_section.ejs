<!-- Items Panel -->
<div class="card">
    <div class="card-header">
        <h3>Items</h3>
    </div>
    <div class="card-body">
        <% for(let i = 0; i < 4; i++) { %>
            <% const item = items[i] || {} %>
            <div class="mb-3 p-2 border rounded item-row" data-metal-type="<%= item.metal_type || 'Gold' %>">
                <h5 class="mb-3">Item <%= i + 1 %></h5>
                <input type="hidden" name="items[<%= i %>][id]" value="<%= item.id || '' %>">
                <input type="hidden" name="items[<%= i %>][weightType]" id="weightTypeHidden<%= i %>" value="<%= item.weight_type || '' %>">
                <div class="item-details-row align-items-center">
                <div class="col-item-name">
                    <label for="itemName<%= i %>" class="form-label">Item Name:</label>
                    <input type="text" class="form-control" id="itemName<%= i %>" name="items[<%= i %>][name]" value="<%= item.item_name || '' %>">
                </div>
                <div class="col-metal-type">
                    <label for="metalType<%= i %>" class="form-label">Metal Type:</label>
                    <select class="form-select metal-type-select" id="metalType<%= i %>" name="items[<%= i %>][metalType]">
                        <option value="Gold" <%= (item.metal_type === 'Gold' ? 'selected' : '') %>>Gold</option>
                        <option value="Silver" <%= (item.metal_type === 'Silver' ? 'selected' : '') %>>Silver</option>
                    </select>
                </div>
                <div class="col-qty">
                    <label for="quantity<%= i %>" class="form-label">Qty:</label>
                    <input type="number" class="form-control quantity-input" id="quantity<%= i %>" name="items[<%= i %>][quantity]" value="<%= item.quantity || 1 %>" min="1">
                </div>
                <div class="col-percent">
                    <label for="percent<%= i %>" class="form-label">%:</label>
                    <input type="number" class="form-control" id="percent<%= i %>" name="items[<%= i %>][percent]" value="<%= item.percent || '' %>" step="0.01">
                </div>
                <div class="col-weight-type">
                    <label for="weightType<%= i %>" class="form-label">Weight Type:</label>
                    <select class="form-select weight-type-select" id="weightType<%= i %>" data-index="<%= i %>">
                        <option value="">Select...</option>
                        <option value="1" <%= (item.weight_type === '1' ? 'selected' : '') %>>1g</option>
                        <option value="5" <%= (item.weight_type === '5' ? 'selected' : '') %>>5g</option>
                        <option value="10" <%= (item.weight_type === '10' ? 'selected' : '') %>>10g</option>
                        <option value="20" <%= (item.weight_type === '20' ? 'selected' : '') %>>20g</option>
                        <option value="50" <%= (item.weight_type === '50' ? 'selected' : '') %>>50g</option>
                        <option value="1.41748" <%= (item.weight_type === '1.41748' ? 'selected' : '') %>>1/20 oz</option>
                        <option value="2.83495" <%= (item.weight_type === '2.83495' ? 'selected' : '') %>>1/10 oz</option>
                        <option value="14.17476" <%= (item.weight_type === '14.17476' ? 'selected' : '') %>>1/2 oz</option>
                        <option value="28.34952" <%= (item.weight_type === '28.34952' ? 'selected' : '') %>>1 oz</option>
                        <option value="56.69904" <%= (item.weight_type === '56.69904' ? 'selected' : '') %>>2 oz</option>
                        <option value="141.7476" <%= (item.weight_type === '141.7476' ? 'selected' : '') %>>5 oz</option>
                        <option value="283.4952" <%= (item.weight_type === '283.4952' ? 'selected' : '') %>>10 oz</option>
                        <option value="1000" <%= (item.weight_type === '1000' ? 'selected' : '') %>>1 Kgs</option>
                    </select>
                </div>
                <div class="col-weight">
                    <label for="weight<%= i %>" class="form-label">Weight (g):</label>
                    <input type="number" class="form-control weight-input" id="weight<%= i %>" name="items[<%= i %>][weight]" value="<%= item.weight || '' %>" step="any" placeholder="0.0000">
                </div>
                <div class="col-live-price">
                    <label>Live Price:</label>
                    <% 
                        let livePrice = 0;
                        if (typeof quote !== 'undefined' && item.weight) {
                            const quantity = item.quantity || 1;
                            if (item.metal_type === 'Gold') {
                                livePrice = item.weight * quote.spot_price_gold_gram_nzd * quantity;
                            } else if (item.metal_type === 'Silver') {
                                livePrice = item.weight * quote.spot_price_silver_gram_nzd * quantity;
                            }
                        }
                    %>
                    <p><strong>$<span class="live-price"><%= livePrice.toFixed(2) %></span> NZD</strong></p>
                </div>
                </div>
            </div>
        <% } %>
        <% if (typeof quote !== 'undefined') { %>
        <div class="row justify-content-end" style="margin-top: 80px;">
            <div class="col-md-auto d-flex align-items-baseline">
                <p class="grand-total-title me-3">Grand Total:</p>
                <p class="grand-total-value">$<span id="grand-total">0.00</span> <span class="currency-unit">NZD</span></p>
            </div>
        </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Handle weight type dropdown selection (works on all pages)
    document.querySelectorAll('.weight-type-select').forEach(select => {
        select.addEventListener('change', (e) => {
            const index = e.target.dataset.index;
            const weightInput = document.getElementById(`weight${index}`);
            const hiddenWeightType = document.getElementById(`weightTypeHidden${index}`);
            const selectedValue = e.target.value;
            
            // Update the hidden field with the selected weight type
            hiddenWeightType.value = selectedValue;
            
            if (selectedValue) {
                // Set the weight value with high precision
                weightInput.value = parseFloat(selectedValue).toFixed(5);
                // Trigger the input event to update live prices if applicable
                weightInput.dispatchEvent(new Event('input'));
            }
        });
    });
});
</script>

<% if (typeof quote !== 'undefined') { %>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const card = document.getElementById('edit-quote-card') || document.getElementById('create-quote-card');
    let currentPrices = {
        gold_gram_nzd: parseFloat(card.dataset.goldGramNzd) || 0,
        silver_gram_nzd: parseFloat(card.dataset.silverGramNzd) || 0
    };

    function updateLivePrices() {
        let grandTotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const weightInput = row.querySelector('.weight-input');
            const percentInput = row.querySelector('input[name*="[percent]"]');
            const quantityInput = row.querySelector('.quantity-input');
            const livePriceSpan = row.querySelector('.live-price');
            const metalTypeSelect = row.querySelector('.metal-type-select');
            
            const metalType = metalTypeSelect.value;
            const weight = parseFloat(weightInput.value) || 0;
            const percent = parseFloat(percentInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 1;

            row.dataset.metalType = metalType;

            let basePrice = 0;
            if (metalType === 'Gold') {
                basePrice = weight * currentPrices.gold_gram_nzd;
            } else if (metalType === 'Silver') {
                basePrice = weight * currentPrices.silver_gram_nzd;
            }
            
            const finalPrice = basePrice * quantity * (1 - (percent / 100));
            livePriceSpan.textContent = finalPrice.toFixed(2);
            grandTotal += finalPrice;
        });

        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }

    // Initial calculation on page load
    updateLivePrices();

    document.querySelectorAll('input[name*="[name]"], .metal-type-select, input[name*="[percent]"], .weight-input, .quantity-input').forEach(input => {
        input.addEventListener('input', updateLivePrices);
    });

    document.addEventListener('pricesUpdated', (e) => {
        currentPrices = e.detail;
        updateLivePrices();
    });
});
</script>
<% } %>
