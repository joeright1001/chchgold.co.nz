<!-- Spot Price Panel -->
<div class="card mb-4">
    <div class="card-header">
        <h2>Spot Price</h2>
    </div>
    <div class="card-body">
        <div class="row spot-price-display">
            <div class="col-6">
                <p>1 Troy Oz Gold:</p>
                <p>1 Troy Oz Silver:</p>
                <p>1 gram Gold:</p>
                <p>1 gram Silver:</p>
                <% 
                    const lastUpdated = typeof quote !== 'undefined' && quote.updated_at 
                        ? new Date(quote.updated_at).toLocaleString() 
                        : 'Not yet loaded';
                %>
                <p class="mt-3 last-updated-text"><i>Last Updated: <span id="last-updated"><%= lastUpdated %></span></i></p>
                <div id="price-error" class="text-danger mt-2"></div>
                <div class="mt-3">
                    <% 
                        const btnId = typeof quote !== 'undefined' && quote.id ? 'refresh-price-btn' : 'get-live-price-btn';
                    %>
                    <button type="button" id="<%= btnId %>" class="btn btn-info">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Update Live Price
                    </button>
                </div>
            </div>
            <div class="col-6">
                <% 
                    const goldOz = typeof quote !== 'undefined' && quote.spot_price_gold_ounce_nzd 
                        ? Number(quote.spot_price_gold_ounce_nzd).toFixed(2) 
                        : '-';
                    const silverOz = typeof quote !== 'undefined' && quote.spot_price_silver_ounce_nzd 
                        ? Number(quote.spot_price_silver_ounce_nzd).toFixed(2) 
                        : '-';
                    const goldG = typeof quote !== 'undefined' && quote.spot_price_gold_gram_nzd 
                        ? Number(quote.spot_price_gold_gram_nzd).toFixed(2) 
                        : '-';
                    const silverG = typeof quote !== 'undefined' && quote.spot_price_silver_gram_nzd 
                        ? Number(quote.spot_price_silver_gram_nzd).toFixed(2) 
                        : '-';
                %>
                <p>$<span id="gold-oz-price"><%= goldOz %></span> <span class="currency-unit">NZD</span></p>
                <p>$<span id="silver-oz-price"><%= silverOz %></span> <span class="currency-unit">NZD</span></p>
                <p>$<span id="gold-g-price"><%= goldG %></span> <span class="currency-unit">NZD</span></p>
                <p>$<span id="silver-g-price"><%= silverG %></span> <span class="currency-unit">NZD</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Items Panel -->
<div class="card">
    <div class="card-header">
        <h3>Items</h3>
    </div>
    <div class="card-body">
        <div id="items-container">
            <% 
            // Show existing items or at least one empty row
            const itemsToShow = (items && items.length > 0) ? items : [{}];
            itemsToShow.forEach((item, i) => { 
            %>
                <div class="mb-3 p-2 border rounded item-row" data-metal-type="<%= item.metal_type || 'Gold' %>" data-row-index="<%= i %>">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Item <span class="item-number"><%= i + 1 %></span></h5>
                        <a href="#" class="remove-item-btn text-danger" style="<%= itemsToShow.length === 1 ? 'display: none;' : '' %>">Remove</a>
                    </div>
                    <input type="hidden" name="items[<%= i %>][id]" value="<%= item.id || '' %>" class="item-id-input">
                    <input type="hidden" name="items[<%= i %>][weightType]" id="weightTypeHidden<%= i %>" value="<%= item.weight_type || '' %>" class="weight-type-hidden">
                    <div class="item-details-row align-items-center">
                    <div class="col-item-name">
                        <label class="form-label">Item Name:</label>
                        <input type="text" class="form-control item-name-input" name="items[<%= i %>][name]" value="<%= item.item_name || '' %>">
                    </div>
                    <div class="col-metal-type">
                        <label class="form-label">Metal Type:</label>
                        <select class="form-select metal-type-select" name="items[<%= i %>][metalType]">
                            <option value="Gold" <%= (item.metal_type === 'Gold' ? 'selected' : '') %>>Gold</option>
                            <option value="Silver" <%= (item.metal_type === 'Silver' ? 'selected' : '') %>>Silver</option>
                        </select>
                    </div>
                    <div class="col-qty">
                        <label class="form-label">Qty:</label>
                        <input type="number" class="form-control quantity-input" name="items[<%= i %>][quantity]" value="<%= item.quantity || 1 %>" min="1">
                    </div>
                    <div class="col-percent">
                        <label class="form-label">%:</label>
                        <input type="number" class="form-control percent-input" name="items[<%= i %>][percent]" value="<%= item.percent || '' %>" step="0.01">
                    </div>
                    <div class="col-weight-type">
                        <label class="form-label">Weight Type:</label>
                        <select class="form-select weight-type-select" data-index="<%= i %>">
                            <option value="">Select...</option>
                            <option value="1" <%= (item.weight_type === '1' ? 'selected' : '') %>>1g</option>
                            <option value="5" <%= (item.weight_type === '5' ? 'selected' : '') %>>5g</option>
                            <option value="10" <%= (item.weight_type === '10' ? 'selected' : '') %>>10g</option>
                            <option value="20" <%= (item.weight_type === '20' ? 'selected' : '') %>>20g</option>
                            <option value="50" <%= (item.weight_type === '50' ? 'selected' : '') %>>50g</option>
                            <option value="1.41748" <%= (item.weight_type === '1.41748' ? 'selected' : '') %>>1/20 oz</option>
                            <option value="2.83495" <%= (item.weight_type === '2.83495' ? 'selected' : '') %>>1/10 oz</option>
                            <option value="14.17476" <%= (item.weight_type === '14.17476' ? 'selected' : '') %>>1/2 oz</option>
                            <option value="28.34952" <%= (item.weight_type === '28.34952' ? 'selected' : '') %>>1 oz</option>
                            <option value="56.69904" <%= (item.weight_type === '56.69904' ? 'selected' : '') %>>2 oz</option>
                            <option value="141.7476" <%= (item.weight_type === '141.7476' ? 'selected' : '') %>>5 oz</option>
                            <option value="283.4952" <%= (item.weight_type === '283.4952' ? 'selected' : '') %>>10 oz</option>
                            <option value="1000" <%= (item.weight_type === '1000' ? 'selected' : '') %>>1 Kgs</option>
                        </select>
                    </div>
                    <div class="col-weight">
                        <label class="form-label">Weight (g):</label>
                        <input type="number" class="form-control weight-input" name="items[<%= i %>][weight]" value="<%= item.weight || '' %>" step="any" placeholder="0.0000">
                    </div>
                    <div class="col-live-price">
                        <label>Live Price:</label>
                        <% 
                            let livePrice = 0;
                            if (typeof quote !== 'undefined' && item.weight) {
                                const quantity = item.quantity || 1;
                                if (item.metal_type === 'Gold') {
                                    livePrice = item.weight * quote.spot_price_gold_gram_nzd * quantity;
                                } else if (item.metal_type === 'Silver') {
                                    livePrice = item.weight * quote.spot_price_silver_gram_nzd * quantity;
                                }
                            }
                        %>
                        <p><strong>$<span class="live-price"><%= livePrice.toFixed(2) %></span> NZD</strong></p>
                    </div>
                    </div>
                </div>
            <% }); %>
        </div>
        
        <!-- Add Item Button -->
        <div class="mt-3 mb-3">
            <a href="#" id="add-item-btn" class="text-success">+ Add Item</a>
        </div>
        
        <% if (typeof quote !== 'undefined') { %>
        <div class="row justify-content-end" style="margin-top: 80px;">
            <div class="col-md-auto d-flex align-items-baseline">
                <p class="grand-total-title me-3">Grand Total:</p>
                <p class="grand-total-value">$<span id="grand-total">0.00</span> <span class="currency-unit">NZD</span></p>
            </div>
        </div>
        <% } %>
    </div>
</div>

<script src="/js/items_management.js"></script>
